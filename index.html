<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Titanic: Ultimate Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000b1a; font-family: 'Arial Black', sans-serif; color: white; }
        canvas { display: block; touch-action: none; }
        
        #main-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #001a33, #000);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000;
        }
        h1 { font-size: 45px; text-shadow: 0 0 20px #3498db; text-align: center; }
        .level-selector { margin: 20px 0; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        .lvl-btn {
            padding: 10px 15px; background: rgba(255,255,255,0.1);
            border: 2px solid #3498db; color: white; cursor: pointer; border-radius: 8px;
        }
        .lvl-btn.active { background: #3498db; box-shadow: 0 0 15px #3498db; }
        .play-btn {
            padding: 15px 50px; font-size: 24px; background: #2ecc71;
            border: none; color: white; cursor: pointer; border-radius: 40px;
        }

        #ui { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 24px; display: none; z-index: 10; text-shadow: 2px 2px #000; }
        #joy-base {
            position: absolute; bottom: 50px; left: 50px;
            width: 120px; height: 120px; background: rgba(255,255,255,0.1);
            border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; z-index: 100; display: none;
        }
        #joy-stick { width: 50px; height: 50px; background: #fff; border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 0 15px #000; }

        .screen {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); padding: 40px; border-radius: 20px;
            text-align: center; display: none; z-index: 1000; border: 4px solid #f1c40f;
        }
        .screen button { padding: 12px 30px; background: #3498db; color: white; border: none; border-radius: 15px; cursor: pointer; font-size: 20px; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="main-menu">
        <h1>SAVING THE TITANIC</h1>
        <div class="level-selector">
            <button class="lvl-btn active" onclick="selectLevel(0, this)">1 (20s)</button>
            <button class="lvl-btn" onclick="selectLevel(1, this)">2 (50s)</button>
            <button class="lvl-btn" onclick="selectLevel(2, this)">3 (1m)</button>
            <button class="lvl-btn" onclick="selectLevel(3, this)">4 (1.5m)</button>
            <button class="lvl-btn" onclick="selectLevel(4, this)">5 (2m)</button>
        </div>
        <button class="play-btn" onclick="startGame()">START MISSION</button>
    </div>

    <div id="ui">APPROACHING NY: <span id="timer">0</span>s</div>
    <div id="joy-base"><div id="joy-stick"></div></div>

    <div class="screen" id="gameOver">
        <h2 style="color:#e74c3c; font-size: 50px;">SANK!</h2>
        <button onclick="backToMenu()">TRY AGAIN</button>
    </div>

    <div class="screen" id="winScreen">
        <h2 style="color:#f1c40f; font-size: 50px;">NEW YORK!</h2>
        <p>The unsinkable reached the port.</p>
        <button onclick="backToMenu()" style="background:#2ecc71;">MENU</button>
    </div>

    <canvas id="game"></canvas>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const joyBase = document.getElementById('joy-base');
    const joyStick = document.getElementById('joy-stick');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let gameActive = false, nyVisible = false, nyY = -1000, moveX = 0, moveY = 0;
    let selectedLvlIdx = 0, timeLeft = 20, timerInterval;
    const levels = [20, 50, 60, 90, 120];
    let ship = { x: canvas.width/2, y: canvas.height - 200 };
    let icebergs = [];

    // AUDIO
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx, oceanSource;

    function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); }

    function playOcean() {
        if(oceanSource) oceanSource.stop();
        const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
        const data = buf.getChannelData(0);
        for (let i = 0; i < buf.length; i++) data[i] = Math.random() * 2 - 1;
        oceanSource = audioCtx.createBufferSource();
        oceanSource.buffer = buf; oceanSource.loop = true;
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass'; filter.frequency.value = 250;
        const gain = audioCtx.createGain(); gain.gain.value = 0.15;
        oceanSource.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
        oceanSource.start();
    }

    function playCrash() {
        const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(60, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.8);
    }

    function selectLevel(idx, btn) {
        document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedLvlIdx = idx;
        timeLeft = levels[idx];
    }

    function startGame() {
        initAudio();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        playOcean();
        ship = { x: canvas.width/2, y: canvas.height - 200 };
        icebergs = []; nyY = -1000; nyVisible = false;
        timeLeft = levels[selectedLvlIdx];
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('gameOver').style.display = 'none';
        document.getElementById('winScreen').style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        joyBase.style.display = 'block';
        gameActive = true;
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(gameActive && timeLeft > 0) {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if(timeLeft <= 0) nyVisible = true;
            }
        }, 1000);
        loop();
    }

    function backToMenu() {
        gameActive = false;
        if(oceanSource) oceanSource.stop();
        clearInterval(timerInterval);
        document.getElementById('main-menu').style.display = 'flex';
        document.getElementById('gameOver').style.display = 'none';
        document.getElementById('winScreen').style.display = 'none';
        document.getElementById('ui').style.display = 'none';
        joyBase.style.display = 'none';
    }

    // JOYSTICK
    let dragging = false;
    function updateJoy(e) {
        if(!dragging) return;
        const r = joyBase.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        const dx = cx - (r.left + r.width/2), dy = cy - (r.top + r.height/2);
        const d = Math.min(Math.hypot(dx, dy), 50);
        const a = Math.atan2(dy, dx);
        moveX = (Math.cos(a) * d) / 50; moveY = (Math.sin(a) * d) / 50;
        joyStick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
    }
    window.addEventListener('mousedown', () => dragging = true);
    window.addEventListener('touchstart', (e) => { dragging = true; updateJoy(e); });
    window.addEventListener('mousemove', updateJoy);
    window.addEventListener('touchmove', (e) => { if(gameActive) e.preventDefault(); updateJoy(e); }, {passive: false});
    window.addEventListener('mouseup', () => { dragging = false; moveX = 0; moveY = 0; joyStick.style.transform = 'none'; });
    window.addEventListener('touchend', () => { dragging = false; moveX = 0; moveY = 0; joyStick.style.transform = 'none'; });

    function drawNY() {
        ctx.save(); ctx.translate(0, nyY);
        ctx.fillStyle = '#050505'; ctx.fillRect(0, 500, canvas.width, 600);
        for(let i=0; i<canvas.width; i+=80) {
            let h = 400 + Math.sin(i)*180;
            ctx.fillStyle = '#0a0a1a'; ctx.fillRect(i, 500-h, 70, h);
            ctx.fillStyle = (Date.now() % 1000 > 500) ? '#f00' : '#300'; ctx.fillRect(i+30, 500-h-5, 10, 5);
            for(let r=0; r<h-50; r+=30) {
                ctx.fillStyle = Math.random()>0.1 ? '#f1c40f':'#222';
                ctx.fillRect(i+15, 500-h+r, 8, 8); ctx.fillRect(i+45, 500-h+r, 8, 8);
            }
        }
        ctx.fillStyle = '#2d8a8a'; let sx = canvas.width/2 - 50;
        ctx.fillRect(sx, 150, 100, 350); ctx.beginPath(); ctx.arc(sx+50, 130, 55, 0, 7); ctx.fill();
        ctx.fillStyle = '#f1c40f'; ctx.shadowBlur = 25; ctx.shadowColor = '#f1c40f'; ctx.fillRect(sx+90, 60, 20, 60);
        ctx.restore();
        if(nyY < 0) nyY += 4;
        if(nyY >= 0 && ship.y < 580) { gameActive = false; document.getElementById('winScreen').style.display = 'block'; }
    }

    function drawShip() {
        ctx.save(); ctx.translate(ship.x, ship.y);
        
        // Водяной след (пена)
        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.beginPath(); ctx.ellipse(0, 60, 45, 100, 0, 0, Math.PI*2); ctx.fill();

        // КРАСИВЫЙ КОРПУС ТИТАНИКА
        ctx.shadowBlur = 10; ctx.shadowColor = 'black';
        ctx.fillStyle = '#0a0a0a'; // Черный низ
        ctx.beginPath();
        ctx.moveTo(0, -110); // Нос
        ctx.bezierCurveTo(45, -60, 45, 80, 0, 110); // Правый борт
        ctx.bezierCurveTo(-45, 80, -45, -60, 0, -110); // Левый борт
        ctx.fill();

        // Белая верхняя палуба
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(0, -60);
        ctx.bezierCurveTo(28, -40, 28, 60, 0, 95);
        ctx.bezierCurveTo(-28, 60, -28, -40, 0, -60);
        ctx.fill();

        // Иллюминаторы (огоньки на бортах)
        ctx.fillStyle = '#f1c40f';
        for(let i=-60; i<80; i+=20) {
            ctx.beginPath(); ctx.arc(33, i, 2, 0, 7); ctx.fill();
            ctx.beginPath(); ctx.arc(-33, i, 2, 0, 7); ctx.fill();
        }

        // Капитанский мостик и надстройки
        ctx.fillStyle = '#ddd';
        ctx.fillRect(-15, -20, 30, 40);
        ctx.fillStyle = '#333'; ctx.fillRect(-15, -15, 30, 5); // Окна мостика

        // 4 ВЕЛИЧЕСТВЕННЫЕ ТРУБЫ
        for(let i=0; i<4; i++) {
            let ty = -50 + (i * 32);
            // Дым
            ctx.fillStyle = 'rgba(100,100,100,0.3)';
            ctx.beginPath(); ctx.arc(Math.sin(Date.now()/200+i)*5, ty-15, 8 + Math.random()*5, 0, 7); ctx.fill();
            
            // Сама труба
            ctx.fillStyle = '#e67e22'; // Оранжевый
            ctx.fillRect(-10, ty, 20, 18);
            ctx.fillStyle = '#000'; // Черный верх трубы
            ctx.fillRect(-10, ty, 20, 5);
        }
        
        ctx.restore();
    }

    function loop() {
        if(!gameActive) return;
        ctx.fillStyle = '#000b1a'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Волны на фоне
        ctx.strokeStyle = 'rgba(255,255,255,0.03)';
        let waveOff = (Date.now()/20)%100;
        for(let y=0; y<canvas.height; y+=100) {
            ctx.beginPath(); ctx.moveTo(0, y+waveOff); ctx.lineTo(canvas.width, y+waveOff); ctx.stroke();
        }

        if(nyVisible) drawNY();
        
        ship.x += moveX * 10; ship.y += moveY * 10;
        ship.x = Math.max(50, Math.min(canvas.width-50, ship.x));
        ship.y = Math.max(100, Math.min(canvas.height-100, ship.y));
        
        drawShip();

        if(!nyVisible && Math.random() < 0.025) icebergs.push({ x: Math.random()*canvas.width, y: -100 });
        for(let i=icebergs.length-1; i>=0; i--) {
            let ice = icebergs[i]; ice.y += 9;
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.moveTo(ice.x, ice.y-45); ctx.lineTo(ice.x+45, ice.y+45); ctx.lineTo(ice.x-45, ice.y+45); ctx.fill();
            // Коллизия с учетом нового размера корабля
            if(Math.hypot(ship.x-ice.x, ship.y-ice.y) < 70) { 
                playCrash(); gameActive = false; document.getElementById('gameOver').style.display = 'block';
            }
            if(ice.y > canvas.height+100) icebergs.splice(i,1);
        }
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>
